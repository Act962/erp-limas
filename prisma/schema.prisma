
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id                    String          @id @default(cuid())
  name                  String
  email                 String          @unique
  emailVerified         Boolean         @default(false)
  image                 String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  // Relações de autenticação
  sessions              Session[]
  accounts              Account[]
  // Relações de organização (mantido do seu schema)
  members               Member[]
  invitations           Invitation[]
  // Auditoria de ações no ERP
  createdProducts       Product[]       @relation("CreatedProducts")
  createdSales          Sale[]          @relation("CreatedSales")
  createdStockMovements StockMovement[] @relation("CreatedStockMovements")
  createdPurchases      Purchase[]      @relation("CreatedPurchases")

  @@index([email])
  @@map("user")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Mantido do seu schema - organização ativa na sessão
  activeOrganizationId String?

  @@index([userId])
  @@index([token])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ============================================
// ORGANIZAÇÕES (Seu modelo base mantido)
// Renomeado de Company para Organization
// ============================================

enum PlanType {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

model Organization {
  id                String             @id @default(cuid())
  name              String
  slug              String             @unique
  logo              String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  metadata          String? // Mantido do seu schema
  // Dados da empresa
  tradeName         String? // Nome fantasia
  document          String?            @unique // CNPJ/CPF
  email             String?
  phone             String?
  // Multi-tenant e Catálogo
  subdomain         String?            @unique // empresa1.seuapp.com
  customDomain      String?            @unique // minhaloja.com.br
  // Endereço
  address           String?
  addressNumber     String?
  complement        String?
  neighborhood      String?
  city              String?
  state             String?
  zipCode           String?
  country           String             @default("BR")
  // Configurações visuais
  primaryColor      String             @default("#3b82f6")
  // Plano e status
  plan              PlanType           @default(FREE)
  status            OrganizationStatus @default(TRIAL)
  // Limites por plano
  maxProducts       Int                @default(100)
  maxUsers          Int                @default(3)
  // Datas importantes
  trialEndsAt       DateTime?
  subscribedAt      DateTime?
  // Relações de membros (mantido do seu schema)
  members           Member[]
  invitations       Invitation[]
  // Relações do ERP
  products          Product[]
  categories        Category[]
  customers         Customer[]
  suppliers         Supplier[]
  sales             Sale[]
  purchases         Purchase[]
  stockMovements    StockMovement[]
  catalogSettings   CatalogSettings?
  financialAccounts FinancialAccount[]
  transactions      Transaction[]
  catalogUsers CatalogUser[]


  @@index([slug])
  @@index([subdomain])
  @@index([customDomain])
  @@index([document])
  @@index([status])
  @@map("organization")
}

// Mantido exatamente como seu schema

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime     @default(now())

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

// Mantido exatamente como seu schema

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

// ============================================
// CATÁLOGO ONLINE - CONFIGURAÇÕES
// ============================================

enum CatalogSortOrder {
  ASC
  DESC
  NEWEST
  OLDEST
}

enum DeliveryMethod {
  DELIVERY_HOME
  PICKUP_STORE
  ROOM_SERVICE
  DIGITAL_DELIVERY
}

enum FreightOption {
  NEGOTIATE_WHATSAPP
  NEGOTIATE_FREIGHT
  FREE_SHIPPING
  NO_SHIPPING
}

enum FreightChargeType {
  FIXED 
  PER_KG 
}


model CatalogSettings {
  id              String       @id @default(cuid())
  organizationId  String       @unique
  // Visibilidade
  isActive        Boolean      @default(true)
  showPrices      Boolean      @default(true)
  showProductWithoutStock Boolean @default(false)
  showStock       Boolean      @default(false)
  allowOrders     Boolean      @default(false)
  sortOrder       CatalogSortOrder @default(ASC)
  // Contato
  whatsappNumber  String?
  showWhatsapp    Boolean      @default(true)
  contactEmail    String?
  //Adress
  cep             String?
  address         String?
  district        String?
  number          String?
  // SEO
  metaTitle       String?
  metaDescription String?
  cnpj            String?
  // Personalização
  logo     String?
  bannerImages    String[]    @default([])
  aboutText       String?      @db.Text
  theme           String? @default("#00bcd4")
  //Payment
  paymentMethodSettings PaymentMethod[]
  //Delivery
  deliveryMethods DeliveryMethod[]
  deliverySpecialInfo String?
  //Settings Delivery
  freightOptions FreightOption @default(NO_SHIPPING)
  freightChargeType FreightChargeType @default(FIXED)
  freightFixedValue      Decimal       @default(0)  @db.Decimal(10, 2)
  freightValuePerKg      Decimal       @default(0)  @db.Decimal(10, 2)
  freeShippingEnabled    Boolean      @default(false)
  freeShippingMinValue   Decimal       @default(0)  @db.Decimal(10, 2)
  //Integrations
  id_meta         String?
  pixel_meta      String?
  //Stripe
  stripeKey String? @map("stripe_key")
  //Asaas
  walletId String? @map("wallet_id")
  // Redes Sociais
  instagram       String?
  facebook        String?
  twitter         String?
  youtube         String?
  kwai            String?
  tiktok          String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("catalog_settings")
}

// ============================================
// PRODUTOS E CATEGORIAS
// ============================================

model Category {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  slug           String
  description    String?
  image          String?
  order          Int          @default(0)
  isActive       Boolean      @default(true)
  // Hierarquia (categoria pai)
  parentId       String?
  parent         Category?    @relation("SubCategories", fields: [parentId], references: [id], onDelete: Cascade)
  children       Category[]   @relation("SubCategories")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products       Product[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([parentId])
  @@map("categories")
}

enum ProductUnit {
  UN // Unidade
  KG // Quilograma
  G // Grama
  L // Litro
  ML // Mililitro
  M // Metro
  M2 // Metro quadrado
  M3 // Metro cúbico
  CX // Caixa
  PC // Peça
  PAR // Par
  DZ // Dúzia
}

model Product {
  id               String          @id @default(cuid())
  organizationId   String
  categoryId       String?
  // Informações básicas
  name             String
  slug             String
  description      String?         @db.Text
  sku              String? // Código interno
  barcode          String? // Código de barras
  // Preços
  costPrice        Decimal         @default(0) @db.Decimal(10, 2)
  salePrice        Decimal         @db.Decimal(10, 2)
  promotionalPrice Decimal?        @db.Decimal(10, 2)
  // Estoque
  unit             ProductUnit     @default(UN)
  currentStock     Decimal         @default(0) @db.Decimal(10, 3)
  minStock         Decimal         @default(0) @db.Decimal(10, 3)
  maxStock         Decimal?        @db.Decimal(10, 3)
  // Imagens
  images           String[] // Array de URLs
  thumbnail        String // URL da thumbnail
  // Dimensões e peso
  weight           Decimal?        @db.Decimal(10, 3)
  length           Decimal?        @db.Decimal(10, 2)
  width            Decimal?        @db.Decimal(10, 2)
  height           Decimal?        @db.Decimal(10, 2)
  // Controle
  isActive         Boolean         @default(true)
  isFeatured       Boolean         @default(false)
  trackStock       Boolean         @default(true)
  // Timestamps
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  createdById      String
  // Relações
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category         Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdBy        User            @relation("CreatedProducts", fields: [createdById], references: [id])
  saleItems        SaleItem[]
  purchaseItems    PurchaseItem[]
  stockMovements   StockMovement[]

  @@unique([organizationId, slug])
  // @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([categoryId])
  @@index([barcode])
  @@index([isActive])
  @@map("products")
}

// ============================================
// ESTOQUE - MOVIMENTAÇÕES
// ============================================

enum MovementType {
  ENTRADA // Entrada manual
  SAIDA // Saída manual
  VENDA // Saída por venda
  COMPRA // Entrada por compra
  DEVOLUCAO // Devolução de venda
  AJUSTE // Ajuste de inventário
  TRANSFERENCIA // Transferência entre locais
  PERDA // Perda/Quebra
}

model StockMovement {
  id             String       @id @default(cuid())
  organizationId String
  productId      String
  type           MovementType
  quantity       Decimal      @db.Decimal(10, 3)
  // Estoque antes e depois (para auditoria)
  previousStock  Decimal      @db.Decimal(10, 3)
  newStock       Decimal      @db.Decimal(10, 3)
  // Custo unitário no momento da movimentação
  unitCost       Decimal?     @db.Decimal(10, 2)
  // Referências
  saleId         String?
  purchaseId     String?
  // Observações
  notes          String?      @db.Text
  // Timestamps e usuário
  createdAt      DateTime     @default(now())
  createdById    String
  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy      User         @relation("CreatedStockMovements", fields: [createdById], references: [id])
  sale           Sale?        @relation(fields: [saleId], references: [id])
  purchase       Purchase?    @relation(fields: [purchaseId], references: [id])

  @@index([organizationId])
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([saleId])
  @@index([purchaseId])
  @@map("stock_movements")
}

// ============================================
// CLIENTES
// ============================================

enum PersonType {
  FISICA // Pessoa Física
  JURIDICA // Pessoa Jurídica
}

model Customer {
  id             String       @id @default(cuid())
  organizationId String
  // Identificação
  name           String
  personType     PersonType   @default(FISICA)
  document       String? // CPF ou CNPJ
  email          String
  phone          String?
  // Endereço
  address        String?
  addressNumber  String?
  complement     String?
  neighborhood   String?
  city           String?
  state          String?
  zipCode        String?
  // Informações adicionais
  notes          String?      @db.Text
  isActive       Boolean      @default(true)
  //Assas
  asaasCustomerId String? @map("asaas_customer_id")
  // Timestamps
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sales          Sale[]
  userCatalog  CatalogUser? @relation(fields: [clientId], references: [id])
  clientId String? @unique
  

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([document])
  @@index([email])
  @@map("customers")
}

// ============================================
// FORNECEDORES
// ============================================

model Supplier {
  id             String       @id @default(cuid())
  organizationId String
  // Identificação
  name           String
  tradeName      String?
  document       String // CNPJ
  email          String?
  phone          String?
  // Endereço
  address        String?
  addressNumber  String?
  complement     String?
  neighborhood   String?
  city           String?
  state          String?
  zipCode        String?
  // Informações adicionais
  contactPerson  String?
  notes          String?      @db.Text
  isActive       Boolean      @default(true)
  // Timestamps
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  // Relações
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchases      Purchase[]

  @@unique([organizationId, document])
  @@index([organizationId])
  @@index([document])
  @@map("suppliers")
}

model CatalogUser {
  id             String   @id @default(cuid())
  organizationId String

  email          String
  passwordHash   String
  name           String

  // Dados coletados no checkout
  phone          String?
  address        String?
  city           String?
  state          String?
  zipCode        String?

  // Stripe
  stripeCustomerId String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer Customer?

  @@unique([organizationId, email])
  @@index([organizationId])
  @@map("catalog_users")
}



// ============================================
// VENDAS
// ============================================

enum SaleStatus {
  DRAFT // Rascunho
  CONFIRMED // Confirmado
  PROCESSING // Em processamento
  COMPLETED // Concluído
  CANCELLED // Cancelado
}

enum PaymentMethod {
  DINHEIRO
  PIX
  DEBITO
  CREDITO
  BOLETO
  TRANSFERENCIA
  OUTROS
}

model Sale {
  id             String          @id @default(cuid())
  organizationId String
  customerId     String?
  // Numeração
  invoiceNumber  String? // Número da nota fiscal
  saleNumber     Int // Número sequencial da venda
  // Status
  status         SaleStatus      @default(DRAFT)
  // Valores
  subtotal       Decimal         @db.Decimal(10, 2)
  discount       Decimal         @default(0) @db.Decimal(10, 2)
  shipping       Decimal         @default(0) @db.Decimal(10, 2)
  total          Decimal         @db.Decimal(10, 2)
  // Pagamento
  paymentMethod  PaymentMethod?
  paidAt         DateTime?
  // Observações
  notes          String?         @db.Text
  // Timestamps
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  completedAt    DateTime?
  cancelledAt    DateTime?
  createdById    String?
  // Relações
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer       Customer?       @relation(fields: [customerId], references: [id], onDelete: SetNull)
  createdBy      User?            @relation("CreatedSales", fields: [createdById], references: [id])
  items          SaleItem[]
  stockMovements StockMovement[]
  transactions   Transaction[]

  @@unique([organizationId, saleNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("sales")
}

model SaleItem {
  id          String  @id @default(cuid())
  saleId      String
  productId   String
  // Dados do produto no momento da venda
  productName String
  quantity    Decimal @db.Decimal(10, 3)
  unitPrice   Decimal @db.Decimal(10, 2)
  discount    Decimal @default(0) @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)
  // Relações
  sale        Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

// ============================================
// COMPRAS
// ============================================

enum PurchaseStatus {
  PENDING // Pendente
  CONFIRMED // Confirmado
  RECEIVED // Recebido
  CANCELLED // Cancelado
}

model Purchase {
  id             String          @id @default(cuid())
  organizationId String
  supplierId     String?
  // Numeração
  purchaseNumber Int // Número sequencial
  invoiceNumber  String? // Número da NF do fornecedor
  // Status
  status         PurchaseStatus  @default(PENDING)
  // Valores
  subtotal       Decimal         @db.Decimal(10, 2)
  discount       Decimal         @default(0) @db.Decimal(10, 2)
  shipping       Decimal         @default(0) @db.Decimal(10, 2)
  total          Decimal         @db.Decimal(10, 2)
  // Datas
  orderDate      DateTime        @default(now())
  expectedDate   DateTime?
  receivedDate   DateTime?
  // Observações
  notes          String?         @db.Text
  // Timestamps
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  createdById    String
  // Relações
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplier       Supplier?       @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  createdBy      User            @relation("CreatedPurchases", fields: [createdById], references: [id])
  items          PurchaseItem[]
  stockMovements StockMovement[]
  transactions   Transaction[]

  @@unique([organizationId, purchaseNumber])
  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchases")
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  productId   String
  // Dados
  productName String
  quantity    Decimal  @db.Decimal(10, 3)
  unitPrice   Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  // Relações
  purchase    Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
}

// ============================================
// FINANCEIRO
// ============================================

enum AccountType {
  BANCO // Conta bancária
  CAIXA // Caixa físico
  POUPANCA // Poupança
  INVESTIMENTO // Investimento
  OUTROS // Outros
}

model FinancialAccount {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  type           AccountType   @default(CAIXA)
  bank           String?
  agency         String?
  account        String?
  initialBalance Decimal       @default(0) @db.Decimal(10, 2)
  currentBalance Decimal       @default(0) @db.Decimal(10, 2)
  isActive       Boolean       @default(true)
  isDefault      Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([organizationId])
  @@index([isActive])
  @@map("financial_accounts")
}

enum TransactionType {
  RECEITA // Entrada
  DESPESA // Saída
}

enum TransactionCategory {
  // Receitas
  VENDAS
  SERVICOS
  OUTROS_RECEITAS
  // Despesas
  FORNECEDORES
  SALARIOS
  ALUGUEL
  ENERGIA
  AGUA
  INTERNET
  TELEFONE
  IMPOSTOS
  MARKETING
  MANUTENCAO
  OUTROS_DESPESAS
}

enum TransactionStatus {
  PENDING // Pendente
  PAID // Pago
  OVERDUE // Atrasado
  CANCELLED // Cancelado
}

model Transaction {
  id             String              @id @default(cuid())
  organizationId String
  accountId      String
  type           TransactionType
  category       TransactionCategory
  status         TransactionStatus   @default(PENDING)
  description    String
  amount         Decimal             @db.Decimal(10, 2)
  // Datas
  dueDate        DateTime
  paidAt         DateTime?
  // Referências
  saleId         String?
  purchaseId     String?
  // Recorrência
  isRecurring    Boolean             @default(false)
  recurringDay   Int? // Dia do mês
  // Observações
  notes          String?             @db.Text
  attachment     String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  // Relações
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account        FinancialAccount    @relation(fields: [accountId], references: [id], onDelete: Restrict)
  sale           Sale?               @relation(fields: [saleId], references: [id])
  purchase       Purchase?           @relation(fields: [purchaseId], references: [id])

  @@index([organizationId])
  @@index([accountId])
  @@index([type])
  @@index([status])
  @@index([dueDate])
  @@index([saleId])
  @@index([purchaseId])
  @@map("transactions")
}
